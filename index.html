<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <title>Liste Mobil-Home</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f7f9fc;
      margin: 0;
      padding: 0;
    }

    h1 {
      text-align: center;
      margin-top: 30px;
      color: #1976d2;
    }

    .container {
      max-width: 900px;
      margin: 40px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 16px #1976d233;
      padding: 30px;
    }

    .search-bar {
      margin-bottom: 20px;
      text-align: center;
    }

    .search-bar input {
      width: 50%;
      padding: 10px 15px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1em;
      outline: none;
    }

    .search-bar button {
      margin-left: 10px;
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      background: #1976d2;
      color: white;
      font-size: 0.95em;
      cursor: pointer;
    }

    .search-bar button:hover {
      background: #125a9c;
    }

    .listview {
      margin-top: 20px;
    }

    .type-title {
      font-size: 1.3em;
      color: #1976d2;
      margin-top: 30px;
    }

    .numero-block {
      margin: 18px 0 28px 0;
      padding: 16px 24px;
      background: #e3f2fd;
      border-radius: 8px;
    }

    .numero-title {
      font-size: 1.1em;
      color: #333;
      margin-bottom: 8px;
    }

    .famille-title {
      font-weight: bold;
      color: #1565c0;
      margin-top: 10px;
    }

    .sousfamille-list {
      margin-left: 18px;
    }

    .sousfamille-item {
      margin: 4px 0;
      color: #444;
    }

    .travaux-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2em;
      margin-right: 8px;
      vertical-align: middle;
    }

    .travaux-btn:hover {
      color: #ff9800;
    }

    .moyenne {
      color: #ffb300;
      font-weight: bold;
      margin-left: 10px;
    }

    .empty {
      color: #888;
      text-align: center;
      margin-top: 40px;
    }

    #error-message {
      color: red;
      margin-top: 20px;
    }

    .btn {
      display: block;
      margin: 20px auto 0 auto;
      padding: 18px 40px;
      font-size: 1.5em;
      background: #4caf50;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 8px #4caf5033;
      transition: background 0.2s;
    }

    .btn:hover {
      background: #45a049;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 6px solid #b3d1ff;
      border-top: 6px solid #1976d2;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <div id="loader"
    style="display:flex;align-items:center;justify-content:center;position:fixed;top:0;left:0;width:100vw;height:100vh;background:#fff;z-index:9999;">
    <div style="text-align:center;">
      <div class="spinner"></div>
      <div style="margin-top:18px;color:#1976d2;font-weight:bold;">Chargement...</div>
    </div>
  </div>

  <h1>Liste des Mobil-Homes</h1>
  <button class="btn" onclick="window.open('https://nonodev38.github.io/check_mobil_home/', 'listeMobilHomeWindow')">
    Ouvrir Check MobilHome
  </button>

  <div class="container">
    <!-- üîç Barre de recherche -->
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Rechercher par num√©ro...">
      <button id="toggleFilter">Filtrer par famille</button>
    </div>

    <div id="listview" class="listview"></div>
    <div id="error-message"></div>
  </div>

  <script>
    console.log("Script Recap Mobil-Home charg√© et d√©marr√©");
    // ‚ö°Ô∏è Met ici TES URL d√©ploy√©es en WebApp
    const URL_DATA = "https://script.google.com/macros/s/AKfycbz7J7fOqS9I0r8BrX8Jv7EasTrbQ_M969qixrNZzNi3Z59lGdhV20rtkXxD_0NaEhwX/exec";
    const URL_TRAVAUX = "https://script.google.com/macros/s/AKfycbwGGBmofpa2reyUgxz1P5OVWJIkpwJtKNvp9PX3lnTaZsktPCKMDtD4tV-8N2UxX-0O/exec";

    let allRows = [];
    let travauxDemandes = new Set();
    let filterMode = "numero";

    async function fetchData() {
      const errorDiv = document.getElementById("error-message");
      errorDiv.textContent = "";
      try {
        const res = await fetch(URL_DATA);
        if (!res.ok) {
          const text = await res.text();
          errorDiv.textContent = `Erreur connexion : ${res.status} ${res.statusText}\nR√©ponse brute : ${text}`;
          return [];
        }
        const data = await res.json();
        const rows = Array.isArray(data) ? data : (data.values ? data.values : []);
        return rows.filter(r => r[0] && r[1]).slice(1);
      } catch (err) {
        errorDiv.textContent = "Erreur de connexion au serveur Google Apps Script : " + err;
        return [];
      }
    }

    let travauxDemandesMap = new Map();

    async function fetchTravauxDemandes() {
      try {
        const res = await fetch(URL_TRAVAUX);
        if (!res.ok) return [];
        const data = await res.json();
        const travauxRows = Array.isArray(data) ? data.slice(1) : (data.values ? data.values.slice(1) : []);
        travauxDemandesMap = new Map(
          travauxRows.map(row => [
            [row[2], row[3], row[4], row[5]].map(v => String(v || "").trim().toLowerCase()).join("|||"),
            Number(row[8]) // colonne Travaux ok
          ])
        );
        return travauxRows;
      } catch (err) {
        alert("Erreur lors de la requ√™te GET Travaux : " + err);
        return [];
      }
    }

    async function init() {
      allRows = await fetchData();
      const travauxRows = await fetchTravauxDemandes();
      travauxDemandes = new Set(
        travauxRows.map(row =>
          [row[2], row[3], row[4], row[5]].map(v => String(v || "").trim().toLowerCase()).join("|||")
        )
      );
      console.log("Appel renderListview depuis init, allRows.length =", allRows.length);
      renderListview(allRows);
    }
    init();

    // ====== Affichage de la liste ======
    function renderListview(rows) {
      console.log("renderListview appel√©e, rows.length =", rows.length);
      const listview = document.getElementById("listview");
      listview.innerHTML = "";

      if (!rows.length) {
        listview.innerHTML = '<div class="empty">Aucune donn√©e disponible.</div>';
        return;
      }

      // Calcul des regroupements et moyennes
      let regrouped = {}, etoilesSum = {}, etoilesCount = {};
      rows.forEach(row => {
        let [type, numero, famille, sousfamille, moyenne] = row;
        type = String(type).trim().toUpperCase();
        famille = String(famille).trim();
        numero = String(numero).trim();
        if (!type || !numero || !famille) return;

        const key = `${type}|||${numero}`;
        if (!etoilesCount.hasOwnProperty(key)) {
          etoilesCount[key] = 0;
          etoilesSum[key] = 0;
        }

        if (famille === "MOYENNE") {
          const val = Number(moyenne);
          if (val > 0) {
            etoilesSum[key] += val;
            etoilesCount[key] += 1;
          }
        } else {
          if (!regrouped[key]) regrouped[key] = {};
          if (!regrouped[key][famille]) regrouped[key][famille] = [];
          regrouped[key][famille].push(sousfamille || "Aucun probl√®me signal√©");
        }
      });

      // Affichage
      let lastType = null;
      Object.keys(regrouped)
        .sort((a, b) => {
          // Trie d'abord par type (MH/CH), puis par num√©ro croissant
          const [typeA, numA] = a.split("|||");
          const [typeB, numB] = b.split("|||");
          if (typeA !== typeB) return typeA.localeCompare(typeB);
          return Number(numA) - Number(numB);
        })
        .forEach(key => {
          const [type, numero] = key.split("|||");

          // Type title
          if (type !== lastType) {
            const typeDiv = document.createElement("div");
            typeDiv.className = "type-title";
            typeDiv.textContent = type;
            listview.appendChild(typeDiv);
            lastType = type;
          }

          // Num√©ro block
          const numeroBlock = document.createElement("div");
          numeroBlock.className = "numero-block";
          const numeroTitle = document.createElement("div");
          numeroTitle.className = "numero-title";
          numeroTitle.textContent = `Num√©ro : ${numero}`;
          numeroBlock.appendChild(numeroTitle);

          // Familles
          // ...dans renderListview...
          Object.keys(regrouped[key]).forEach(famille => {
            const familleDiv = document.createElement("div");
            familleDiv.className = "famille-title";
            familleDiv.textContent = famille;
            numeroBlock.appendChild(familleDiv);

            const ul = document.createElement("ul");
            ul.className = "sousfamille-list";

            // Compte les occurrences de chaque sous-famille
            const sousfamilleCounts = {};
            regrouped[key][famille].forEach(sousfamille => {
              const label = String(sousfamille).trim();
              sousfamilleCounts[label] = (sousfamilleCounts[label] || 0) + 1;
            });

            Object.entries(sousfamilleCounts).forEach(([sousfamille, count]) => {
              const li = document.createElement("li");
              li.className = "sousfamille-item";
              const sousfamilleClean = sousfamille.toLowerCase();

              // Cas sp√©cial : aucun probl√®me signal√©
              if (sousfamilleClean === "aucun probl√®me signal√©") {
                li.style.color = "#43a047";
                li.style.fontWeight = "bold";
                li.textContent = "Aucun probl√®me signal√©";
              }
              // Cas sp√©cial : rien √† signaler ou aucun probl√®me (on n'affiche pas)
              else if (
                sousfamilleClean === "rien √† signaler pour ce mobilhome" ||
                sousfamilleClean === "aucun probl√®me"
              ) {
                return;
              }
              // Travaux effectu√©s ou √† demander
              else {
                const travauxKey = [type, numero, famille, sousfamille].map(v => (v || "").trim().toLowerCase()).join("|||");
                const travauxOk = travauxDemandesMap.get(travauxKey);
                const ficheDejaDemandee = travauxDemandesMap.has(travauxKey);

                let countText = count > 1 ? ` (x${count})` : "";
                if (travauxOk === 1) {
                  li.innerHTML = `
          <span style="color:#1976d2;font-weight:bold;">Travaux effectu√©s</span>
          <span style="color:#43a047;font-size:1.2em;margin-left:8px;">&#10004;</span>
          <span style="color:#1976d2;margin-left:8px;">${sousfamille}${countText}</span>
        `;
                } else {
                  li.innerHTML = `
          <button class="travaux-btn" title="Travaux"
            onclick="showTravauxForm('${type}','${numero}','${famille}','${sousfamille.replace(/'/g, "\\'")}', '')">üõ†Ô∏è</button>
            ${ficheDejaDemandee ? '<span title="Fiche travaux d√©j√† demand√©e" style="color:#43a047;font-size:1.2em;margin-left:4px;">&#10004;</span>' : ''}
          ${sousfamille}${countText}${ficheDejaDemandee ? " <span style='color:#43a047;'>(fiche travaux d√©j√† demand√©e)</span>" : ""}
        `;
                }
              }
              ul.appendChild(li);
            });
            numeroBlock.appendChild(ul);

          });

          // Moyenne
          const moyenneDiv = document.createElement("div");
          moyenneDiv.className = "moyenne";
          if (etoilesCount[key]) {
            const moyenneCalculee = (etoilesSum[key] / etoilesCount[key]).toFixed(0);
            console.log("Affichage moyenne pour", key, ":", moyenneCalculee, "‚≠ê");
            moyenneDiv.textContent = `Moyenne calcul√©e : ${moyenneCalculee} ‚≠ê`;
          } else {
            moyenneDiv.innerHTML = `<span style="font-size:1.2em;vertical-align:middle;">&#11088;</span> Aucune √©toile coch√©e √† ce jour`;
            moyenneDiv.style.color = "#888";
          }
          numeroBlock.appendChild(moyenneDiv);

          listview.appendChild(numeroBlock);
        });
      document.getElementById("loader").style.display = "none"; // Cache le loader
    }

// ====== Formulaire Travaux ======
function showTravauxForm(type, numero, famille, sousfamille, moyenne) {
  const now = new Date();
  const dateClick = now.toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' });
  const modal = document.createElement('div');
  
  modal.id = 'travaux-modal';
  modal.style = `
    position:fixed;top:0;left:0;width:100vw;height:100vh;
    background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:9999;
  `;
  modal.innerHTML = `
    <div style="
      background:#fff;
      padding:32px 28px;
      border-radius:16px;
      min-width:320px;
      box-shadow:0 4px 24px #1976d244;
      max-width:95vw;
      font-family:sans-serif;
      position:relative;
    ">
      <button onclick="document.body.removeChild(document.getElementById('travaux-modal'))"
        style="position:absolute;top:18px;right:18px;background:none;border:none;font-size:1.5em;cursor:pointer;color:#1976d2;">&times;</button>
      <h2 style="margin-top:0;color:#1976d2;text-align:center;">Cr√©er Fiche Travaux</h2>
      <div style="margin-bottom:18px;text-align:center;">
        <span style="display:inline-block;background:#e3f2fd;padding:6px 18px;border-radius:8px;color:#1565c0;font-weight:bold;">
          ${type} <span style="color:#333;">#${numero}</span>
        </span>
        <div style="margin-top:8px;color:#1565c0;font-weight:bold;">${famille}</div>
        <div style="margin-top:4px;color:#1976d2;font-weight:bold;">${sousfamille}</div>
      </div>
      <form id="travauxForm" style="margin-top:10px;">
        <fieldset style="border:none;margin:0;padding:0;">
          <legend style="font-weight:bold;color:#1976d2;margin-bottom:8px;">Priorit√© :</legend>
          <label style="display:block;margin-bottom:6px;">
            <input type="radio" name="choix" value="Urgent √† faire de suite"> <span style="color:#d32f2f;">Urgent √† faire de suite</span>
          </label>
          <label style="display:block;margin-bottom:6px;">
            <input type="radio" name="choix" value="A faire dans la journ√©e"> <span style="color:#fbc02d;">A faire dans la journ√©e</span>
          </label>
          <label style="display:block;margin-bottom:6px;">
            <input type="radio" name="choix" value="A faire dans la semaine"> <span style="color:#1976d2;">A faire dans la semaine</span>
          </label>
          <label style="display:block;margin-bottom:6px;">
            <input type="radio" name="choix" value="A faire a temps perdu"> <span style="color:#388e3c;">A faire √† temps perdu</span>
          </label>
          <label style="display:block;margin-bottom:6px;">
            <input type="radio" name="choix" value="A faire hors saison"> <span style="color:#616161;">A faire hors saison</span>
          </label>
        </fieldset>
        <div style="margin-top:18px;">
          <label for="dateFinTravaux" style="font-weight:bold;color:#1976d2;">Date de fin travaux personnalis√©e :</label><br>
          <input type="date" id="dateFinTravauxDate" style="padding:6px 10px;border-radius:6px;border:1px solid #b3d1ff;margin-right:8px;">
          <input type="time" id="dateFinTravauxTime" style="padding:6px 10px;border-radius:6px;border:1px solid #b3d1ff;">
          <span id="dateFinTravauxAffiche" style="color:#1976d2;font-weight:bold;display:block;margin-top:8px;"></span>
        </div>
        <div style="margin-top:28px;text-align:center;">
          <button type="submit" style="
            background:#4caf50;color:#fff;font-size:1.1em;font-weight:bold;
            padding:12px 36px;border:none;border-radius:8px;cursor:pointer;box-shadow:0 2px 8px #4caf5033;
            transition:background 0.2s;
          ">Valider</button>
          <button type="button" onclick="document.body.removeChild(document.getElementById('travaux-modal'))" style="
            background:#e0e0e0;color:#333;font-size:1.1em;font-weight:bold;
            padding:12px 36px;border:none;border-radius:8px;cursor:pointer;margin-left:12px;
          ">Annuler</button>
        </div>
      </form>
    </div>
  `;
  document.body.appendChild(modal);

// Affiche la date choisie
const dateInput = modal.querySelector('#dateFinTravauxDate');
const timeInput = modal.querySelector('#dateFinTravauxTime');
const afficheSpan = modal.querySelector('#dateFinTravauxAffiche');

// Ajoute l'heure syst√®me au champ heure
const pad = n => n.toString().padStart(2, '0');
timeInput.value = pad(now.getHours()) + ":" + pad(now.getMinutes());

function updateAffiche() {
  if (dateInput.value) {
    afficheSpan.textContent = "Date choisie : " + dateInput.value + (timeInput.value ? " " + timeInput.value : "");
  } else {
    afficheSpan.textContent = "";
  }
}
dateInput.addEventListener('input', updateAffiche);
timeInput.addEventListener('input', updateAffiche);

document.getElementById('travauxForm').onsubmit = function (e) {
  e.preventDefault();
  const choix = document.querySelector('#travauxForm input[name="choix"]:checked');
  // Autorise la validation si un bouton radio est coch√© OU si une date personnalis√©e est saisie
  if (!choix && !dateInput.value) return;

  document.body.removeChild(modal);

  const sendingDiv = document.createElement('div');
  sendingDiv.id = 'sending-indicator';
  sendingDiv.style = `
    position:fixed;bottom:24px;right:24px;background:#1976d2;color:#fff;
    padding:14px 28px;border-radius:8px;box-shadow:0 2px 8px #1976d233;z-index:9999;font-size:1.1em;
  `;
  sendingDiv.textContent = "Envoi de la fiche travaux en cours...";
  document.body.appendChild(sendingDiv);

  let dateFinObj = new Date(now);
  let travauxEnCoursValue = choix ? choix.value : "";
  if (dateInput.value) {
    let dateStr = dateInput.value;
    let timeStr = timeInput.value || "12:00";
    dateFinObj = new Date(dateStr + "T" + timeStr);
    // Si aucun bouton radio, on met une valeur par d√©faut pour travauxEnCours
    if (!travauxEnCoursValue) travauxEnCoursValue = "Date personnalis√©e";
  } else {
    switch (travauxEnCoursValue) {
      case "Urgent √† faire de suite": dateFinObj.setHours(dateFinObj.getHours() + 1); break;
      case "A faire dans la journ√©e": dateFinObj.setHours(16, 0, 0, 0); break;
      case "A faire dans la semaine": dateFinObj.setDate(dateFinObj.getDate() + 7); break;
      case "A faire a temps perdu": dateFinObj.setMonth(dateFinObj.getMonth() + 1); break;
      case "A faire hors saison":
        let year = dateFinObj.getMonth() > 2 ? dateFinObj.getFullYear() + 1 : dateFinObj.getFullYear();
        dateFinObj = new Date(year, 2, 1, 12, 0, 0, 0);
        break;
    }
  }
  const dateFin = dateFinObj.toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' });
  const tempsRestant = Math.max(0, Math.round((dateFinObj.getTime() - now.getTime()) / (1000 * 60 * 60))) + "h";

  const postData = {
    action: "addTravaux",
    dateDemande: dateClick,
    dateFinTravaux: dateFin,
    type, num: numero, famille, sousFamille: sousfamille,
    tempsRestant, travauxEnCours: travauxEnCoursValue,
    travauxOk: 0,
    meteoPref: "Peu importe" 
  };

  fetch(URL_TRAVAUX, { method: "POST", body: new URLSearchParams(postData) })
    .then(res => {
      res.text().then(txt => {
        try {
          const data = JSON.parse(txt);
          sendingDiv.textContent = data.result === "ok"
            ? "Fiche travaux envoy√©e avec succ√®s !"
            : "Erreur lors de l'envoi : " + (data.error || "inconnue");
        } catch (err) {
          sendingDiv.textContent = "R√©ponse non JSON : " + txt;
        }
        setTimeout(() => {
          if (sendingDiv.parentNode) sendingDiv.parentNode.removeChild(sendingDiv);
        }, 3000);
      });
      return res;
    })
    .catch(err => {
      alert("Erreur r√©seau : " + err);
      sendingDiv.textContent = "Erreur r√©seau : " + err;
      setTimeout(() => {
        if (sendingDiv.parentNode) sendingDiv.parentNode.removeChild(sendingDiv);
      }, 3000);
    });
};
}

    // ====== Filtres & recherche ======
    function applyFilter(query) {
      if (!query) renderListview(allRows);
      else {
        const filtered = (filterMode === "numero")
          ? allRows.filter(r => String(r[1]).toLowerCase().includes(query))
          : allRows.filter(r => String(r[2]).toLowerCase().includes(query));
        renderListview(filtered);
      }
    }
    document.getElementById("toggleFilter").addEventListener("click", () => {
      filterMode = (filterMode === "numero") ? "famille" : "numero";
      document.getElementById("toggleFilter").textContent = filterMode === "numero" ? "Filtrer par famille" : "Filtrer par num√©ro";
      document.getElementById("searchInput").placeholder = filterMode === "numero" ? "Rechercher par num√©ro..." : "Rechercher par famille...";
      applyFilter(document.getElementById("searchInput").value.trim().toLowerCase());
    });
    document.getElementById("searchInput").addEventListener("input", e => applyFilter(e.target.value.trim().toLowerCase()));

    // ====== Initialisation ======
    init();
    setInterval(() => {
      if (!document.getElementById("searchInput").value.trim()) {
        init();
      }
    }, 30000);
  </script>
</body>

</html>
