<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <title>Liste Mobil-Home</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f7f9fc;
      margin: 0;
      padding: 0;
    }
    h1 {
      text-align: center;
      margin-top: 30px;
      color: #1976d2;
    }
    .container {
      max-width: 900px;
      margin: 40px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 16px #1976d233;
      padding: 30px;
    }
    .search-bar {
      margin-bottom: 20px;
      text-align: center;
    }
    .search-bar input {
      width: 50%;
      padding: 10px 15px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1em;
      outline: none;
    }
    .search-bar button {
      margin-left: 10px;
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      background: #1976d2;
      color: white;
      font-size: 0.95em;
      cursor: pointer;
    }
    .search-bar button:hover { background: #125a9c; }
    .listview { margin-top: 20px; }
    .type-title { font-size: 1.3em; color: #1976d2; margin-top: 30px; }
    .numero-block {
      margin: 18px 0 28px 0;
      padding: 16px 24px;
      background: #e3f2fd;
      border-radius: 8px;
    }
    .numero-title { font-size: 1.1em; color: #333; margin-bottom: 8px; }
    .famille-title { font-weight: bold; color: #1565c0; margin-top: 10px; }
    .sousfamille-list { margin-left: 18px; }
    .sousfamille-item { margin: 4px 0; color: #444; }
    .travaux-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2em;
      margin-right: 8px;
      vertical-align: middle;
    }
    .travaux-btn:hover { color: #ff9800; }
    .moyenne { color: #ffb300; font-weight: bold; margin-left: 10px; }
    .empty { color: #888; text-align: center; margin-top: 40px; }
    #error-message { color: red; margin-top: 20px; }
    .btn {
      display: block;
      margin: 20px auto 0 auto;
      padding: 18px 40px;
      font-size: 1.5em;
      background: #4caf50;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 8px #4caf5033;
      transition: background 0.2s;
    }
    .btn:hover { background: #45a049; }
  </style>
</head>

<body>
  <h1>Liste des Mobil-Homes</h1>
  <button class="btn" onclick="window.open('https://nonodev38.github.io/check_mobil_home/', 'listeMobilHomeWindow')">
    Ouvrir Check MobilHome
  </button>

  <div class="container">
    <!-- üîç Barre de recherche -->
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Rechercher par num√©ro...">
      <button id="toggleFilter">Filtrer par famille</button>
    </div>

    <div id="listview" class="listview"></div>
    <div id="error-message"></div>
  </div>

  <script>
    // ‚ö°Ô∏è Met ici TES URL d√©ploy√©es en WebApp
const URL_DATA = "https://script.google.com/macros/s/AKfycbz7J7fOqS9I0r8BrX8Jv7EasTrbQ_M969qixrNZzNi3Z59lGdhV20rtkXxD_0NaEhwX/exec";
const URL_TRAVAUX = "https://script.google.com/macros/s/AKfycbwMnuc_C_qXhogxLWGJaN75ZRr_plDGazSE14pHVoSQwNkmUi-aXQZrEPz5fCycdl7P/exec";

    let allRows = [];
    let filterMode = "numero"; // mode par d√©faut

    // ====== R√©cup√©ration des donn√©es ======
    async function fetchData() {
      const errorDiv = document.getElementById("error-message");
      errorDiv.textContent = "";
      try {
        const res = await fetch(URL_DATA);
        if (!res.ok) {
          const text = await res.text();
          errorDiv.textContent = `Erreur connexion : ${res.status} ${res.statusText}\nR√©ponse brute : ${text}`;
          return [];
        }
        const data = await res.json();
        const rows = Array.isArray(data) ? data : (data.values ? data.values : []);
        return rows.filter(r => r[0] && r[1]).slice(1);
      } catch (err) {
        errorDiv.textContent = "Erreur de connexion au serveur Google Apps Script : " + err;
        return [];
      }
    }

    // ====== Affichage de la liste ======
    function renderListview(rows) {
      if (!rows.length) {
        document.getElementById("listview").innerHTML = '<div class="empty">Aucune donn√©e disponible.</div>';
        return;
      }
      // Tri par type + num√©ro
      rows.sort((a, b) => {
        const typeCompare = String(a[0]).localeCompare(String(b[0]));
        if (typeCompare !== 0) return typeCompare;
        return (isNaN(a[1]) ? a[1] : Number(a[1])) - (isNaN(b[1]) ? b[1] : Number(b[1]));
      });

      const listview = document.getElementById("listview");
      listview.innerHTML = "";

      let regrouped = {}, etoilesSum = {}, etoilesCount = {};
      rows.forEach(row => {
        const [type, numero, famille, sousfamille, moyenne] = row;
        if (!type || !numero || !famille) return;

        if (famille === "MOYENNE") {
          const key = `${type}|||${numero}`;
          const val = Number(moyenne) || 0;
          etoilesSum[key] = (etoilesSum[key] || 0) + val;
          etoilesCount[key] = (etoilesCount[key] || 0) + 1;
          return;
        }
        if (!sousfamille) return;
        regrouped[`${type}|||${numero}|||${famille}|||${sousfamille}`] =
          (regrouped[`${type}|||${numero}|||${famille}|||${sousfamille}`] || 0) + 1;
      });

      let lastType = null, lastNumero = null, numeroBlock = null, familleBlocks = {}, currentMoyenne = "";

      Object.keys(regrouped).forEach(key => {
        const [type, numero, famille, sousfamille] = key.split("|||");
        const count = regrouped[key];

        if (type !== lastType) {
          listview.innerHTML += `<div class="type-title">${type}</div>`;
          lastType = type; lastNumero = null;
        }
        if (numero !== lastNumero) {
          if (numeroBlock && etoilesCount[`${lastType}|||${lastNumero}`]) {
            const moyenneCalculee = (etoilesSum[`${lastType}|||${lastNumero}`] / etoilesCount[`${lastType}|||${lastNumero}`]).toFixed(0);
            numeroBlock.innerHTML += `<div class="moyenne">Moyenne calcul√©e : ${moyenneCalculee} ‚≠ê</div>`;
            currentMoyenne = moyenneCalculee;
          }
          numeroBlock = document.createElement("div");
          numeroBlock.className = "numero-block";
          numeroBlock.innerHTML = `<div class="numero-title">Num√©ro : ${numero}</div>`;
          listview.appendChild(numeroBlock);
          familleBlocks = {};
          lastNumero = numero;
        }
        if (famille !== "MOYENNE" && !familleBlocks[famille]) {
          familleBlocks[famille] = document.createElement("div");
          familleBlocks[famille].innerHTML = `<div class="famille-title">${famille}</div><ul class="sousfamille-list"></ul>`;
          numeroBlock.appendChild(familleBlocks[famille]);
        }
        if (famille !== "MOYENNE") {
          const ul = familleBlocks[famille].querySelector(".sousfamille-list");
          ul.innerHTML += `<li class="sousfamille-item">
            <button class="travaux-btn" title="Travaux"
              onclick="showTravauxForm('${type}','${numero}','${famille}','${sousfamille.replace(/'/g,"\\'")}', '${currentMoyenne}')">üõ†Ô∏è</button>
            ${sousfamille}${count > 1 ? " <span style='color:#1976d2'>(x" + count + ")</span>" : ""}
          </li>`;
        }
      });
    }

    // ====== Formulaire Travaux ======
    function showTravauxForm(type, numero, famille, sousfamille, moyenne) {
      const now = new Date();
      const dateClick = now.toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' });

      const modal = document.createElement('div');
      modal.id = 'travaux-modal';
      modal.style = "position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:9999;";
      modal.innerHTML = `
        <div style="background:#fff;padding:30px 24px;border-radius:12px;min-width:300px;box-shadow:0 2px 16px #1976d233;">
          <h2>Cr√©er Fiche Travaux</h2>
          <p><b>${type}</b> - <b>${numero}</b> - <b>${famille}</b></p>
          <p style="color:#1976d2;font-weight:bold;">${sousfamille}</p>
          <form id="travauxForm">
            <label><input type="radio" name="choix" value="Urgent √† faire de suite"> Urgent √† faire de suite</label><br>
            <label><input type="radio" name="choix" value="A faire dans la journ√©e"> A faire dans la journ√©e</label><br>
            <label><input type="radio" name="choix" value="A faire dans la semaine"> A faire dans la semaine</label><br>
            <label><input type="radio" name="choix" value="A faire a temps perdu"> A faire √† temps perdu</label><br>
            <label><input type="radio" name="choix" value="A faire hors saison"> A faire hors saison</label><br><br>
            <button type="submit">Valider</button>
            <button type="button" onclick="document.body.removeChild(document.getElementById('travaux-modal'))">Annuler</button>
          </form>
        </div>`;
      document.body.appendChild(modal);

      document.getElementById('travauxForm').onsubmit = function (e) {
        e.preventDefault();
        const choix = document.querySelector('#travauxForm input[name="choix"]:checked');
        if (!choix) return;

        let dateFinObj = new Date(now);
        switch (choix.value) {
          case "Urgent √† faire de suite": dateFinObj.setHours(dateFinObj.getHours() + 1); break;
          case "A faire dans la journ√©e": dateFinObj.setHours(16, 0, 0, 0); break;
          case "A faire dans la semaine": dateFinObj.setDate(dateFinObj.getDate() + 7); break;
          case "A faire a temps perdu": dateFinObj.setMonth(dateFinObj.getMonth() + 1); break;
          case "A faire hors saison":
            let year = dateFinObj.getMonth() > 2 ? dateFinObj.getFullYear() + 1 : dateFinObj.getFullYear();
            dateFinObj = new Date(year, 2, 1, 12, 0, 0, 0);
            break;
        }
        const dateFin = dateFinObj.toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' });
        const tempsRestant = Math.max(0, Math.round((dateFinObj.getTime() - now.getTime()) / (1000 * 60 * 60))) + "h";

        const postData = {
          action: "addTravaux",
          dateDemande: dateClick,
          dateFinTravaux: dateFin,
          type, num: numero, famille, sousFamille: sousfamille,
          tempsRestant, travauxEnCours: choix.value
        };

        fetch(URL_TRAVAUX, { method: "POST", body: new URLSearchParams(postData) })
          .then(res => res.json())
          .then(data => {
            alert(data.result === "ok" ? "Travaux ajout√© !" : "Erreur lors de l'ajout : " + (data.error || "inconnue"));
            document.body.removeChild(modal);
          })
          .catch(err => {
            alert("Erreur r√©seau : " + err);
            document.body.removeChild(modal);
          });
      };
    }

    // ====== Filtres & recherche ======
    function applyFilter(query) {
      if (!query) renderListview(allRows);
      else {
        const filtered = (filterMode === "numero")
          ? allRows.filter(r => String(r[1]).toLowerCase().includes(query))
          : allRows.filter(r => String(r[2]).toLowerCase().includes(query));
        renderListview(filtered);
      }
    }
    document.getElementById("toggleFilter").addEventListener("click", () => {
      filterMode = (filterMode === "numero") ? "famille" : "numero";
      document.getElementById("toggleFilter").textContent = filterMode === "numero" ? "Filtrer par famille" : "Filtrer par num√©ro";
      document.getElementById("searchInput").placeholder = filterMode === "numero" ? "Rechercher par num√©ro..." : "Rechercher par famille...";
      applyFilter(document.getElementById("searchInput").value.trim().toLowerCase());
    });
    document.getElementById("searchInput").addEventListener("input", e => applyFilter(e.target.value.trim().toLowerCase()));

    // ====== Initialisation ======
    fetchData().then(rows => { allRows = rows; renderListview(allRows); });
    setInterval(() => {
      if (!document.getElementById("searchInput").value.trim()) {
        fetchData().then(rows => { allRows = rows; renderListview(allRows); });
      }
    }, 30000);
  </script>
</body>
</html>
